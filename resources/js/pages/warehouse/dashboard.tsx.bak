import {
  Box,
  Grid,
  Heading,
  Text,
  Badge,
  Spinner,
  Center,
  Stack,
  SimpleGrid,
  HStack,
  VStack,
  Icon,
  Alert,
  AlertIcon,
  AlertTitle,
  AlertDescription,
} from '@chakra-ui/react';
import { useEffect, useState } from 'react';
import {
  FiPackage,
  FiLayers,
  FiTrendingUp,
  FiAlertTriangle,
  FiDollarSign,
  FiPieChart,
  FiArrowUp,
  FiArrowDown,
  FiZap,
  FiBarChart2,
  FiUsers,
  FiTrendingDown,
} from 'react-icons/fi';
import { useDashboardAnalytics } from '@/hooks/useAnalytics';
import { useProducts } from '@/hooks/useProducts';
import WarehouseLayout from '@/layouts/WarehouseLayout';

/**
 * Dashboard halaman dengan analytics yang comprehensive
 * Menampilkan financial metrics, trends, movers, alerts, dan operational stats
 */
export default function DashboardPage() {
  const {
    financialMetrics,
    fastMovers,
    slowMovers,
    transactionTrends,
    criticalAlerts,
    categoryPerformance,
    operationalStats,
    loading,
  } = useDashboardAnalytics();

  const { products, fetchLowStockProducts } = useProducts();
  const [lowStockProducts, setLowStockProducts] = useState(0);

  useEffect(() => {
    const loadLowStock = async () => {
      const lowStock = await fetchLowStockProducts();
      if (lowStock) {
        setLowStockProducts(Array.isArray(lowStock) ? lowStock.length : 0);
      }
    };
    loadLowStock();
  }, [fetchLowStockProducts]);

  const cardBg = 'white';
  const borderColor = 'gray.200';

  if (loading) {
    return (
      <WarehouseLayout>
        <Center h="400px">
          <Spinner size="xl" color="teal.500" />
        </Center>
      </WarehouseLayout>
    );
  }

  // Format helper functions
  const formatCurrency = (value: number) => {
    return new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(value);
  };

  const formatNumber = (value: number) => {
    return new Intl.NumberFormat('id-ID').format(value);
  };

  return (
    <WarehouseLayout>
      <Stack gap={6}>
        <Heading size="2xl">üéØ Dashboard Warehouse Intelligence</Heading>

        {/* ============ SECTION 1: FINANCIAL OVERVIEW ============ */}
        <Box bg={cardBg} shadow="md" rounded="lg" p={6} border="1px" borderColor={borderColor}>
          <Heading size="lg" mb={6}>üí∞ Financial Overview</Heading>
          <SimpleGrid columns={{ base: 1, md: 2, lg: 4 }} gap={4}>
            {/* Card 1: Total Inventory Value */}
            <Box bg="teal.50" rounded="lg" p={4} border="1px" borderColor="teal.200">
              <HStack justify="space-between" mb={2}>
                <Text fontSize="sm" color="teal.700" fontWeight="medium">
                  Total Inventory Value
                </Text>
                <Icon as={FiDollarSign} color="teal.500" boxSize={5} />
              </HStack>
              <Text fontSize="2xl" fontWeight="bold" color="teal.900">
                {financialMetrics ? formatCurrency(financialMetrics.total_inventory_value) : '-'}
              </Text>
              <Text fontSize="xs" color="teal.600">Nilai stok saat ini</Text>
            </Box>

            {/* Card 2: Potential Revenue */}
            <Box bg="green.50" rounded="lg" p={4} border="1px" borderColor="green.200">
              <HStack justify="space-between" mb={2}>
                <Text fontSize="sm" color="green.700" fontWeight="medium">
                  Potential Revenue
                </Text>
                <Icon as={FiTrendingUp} color="green.500" boxSize={5} />
              </HStack>
              <Text fontSize="2xl" fontWeight="bold" color="green.900">
                {financialMetrics ? formatCurrency(financialMetrics.potential_revenue) : '-'}
              </Text>
              <Text fontSize="xs" color="green.600">Jika semua stok terjual</Text>
            </Box>

            {/* Card 3: Potential Gross Profit */}
            <Box bg="blue.50" rounded="lg" p={4} border="1px" borderColor="blue.200">
              <HStack justify="space-between" mb={2}>
                <Text fontSize="sm" color="blue.700" fontWeight="medium">
                  Potential Profit
                </Text>
                <Icon as={FiZap} color="blue.500" boxSize={5} />
              </HStack>
              <Text fontSize="2xl" fontWeight="bold" color="blue.900">
                {financialMetrics ? formatCurrency(financialMetrics.potential_gross_profit) : '-'}
              </Text>
              <Text fontSize="xs" color="blue.600">Gross profit potensial</Text>
            </Box>

            {/* Card 4: Avg Transaction Value */}
            <Box bg="purple.50" rounded="lg" p={4} border="1px" borderColor="purple.200">
              <HStack justify="space-between" mb={2}>
                <Text fontSize="sm" color="purple.700" fontWeight="medium">
                  Avg Transaction
                </Text>
                <Icon as={FiBarChart2} color="purple.500" boxSize={5} />
              </HStack>
              <Text fontSize="2xl" fontWeight="bold" color="purple.900">
                {financialMetrics ? formatCurrency(financialMetrics.average_transaction_value) : '-'}
              </Text>
              <Text fontSize="xs" color="purple.600">Rata-rata transaksi 30 hari</Text>
            </Box>
          </SimpleGrid>
        </Box>

        {/* ============ SECTION 2: CRITICAL ALERTS ============ */}
        {criticalAlerts && criticalAlerts.length > 0 && (
          <Box bg={cardBg} shadow="md" rounded="lg" p={6} border="1px" borderColor={borderColor}>
            <Heading size="lg" mb={4}>
              üö® Critical Alerts ({criticalAlerts.length})
            </Heading>
            <Stack gap={3}>
              {criticalAlerts.slice(0, 8).map((alert) => (
                <Alert
                  key={alert.id}
                  status={alert.severity === 'danger' ? 'error' : alert.severity === 'warning' ? 'warning' : 'info'}
                  rounded="lg"
                  variant="left-accent"
                >
                  <AlertIcon />
                  <Box flex={1}>
                    <AlertTitle fontSize="sm">{alert.title}</AlertTitle>
                    <AlertDescription fontSize="xs">{alert.message}</AlertDescription>
                  </Box>
                </Alert>
              ))}
            </Stack>
          </Box>
        )}

        {/* ============ SECTION 3: FAST MOVERS vs SLOW MOVERS ============ */}
        <SimpleGrid columns={{ base: 1, lg: 2 }} gap={6}>
          {/* Fast Movers */}
          <Box bg={cardBg} shadow="md" rounded="lg" p={6} border="1px" borderColor={borderColor}>
            <Heading size="lg" mb={4} display="flex" alignItems="center" gap={2}>
              <Icon as={FiArrowUp} color="green.500" /> Top 10 Fast Movers (30 hari)
            </Heading>
            <VStack gap={3} align="stretch">
              {fastMovers && fastMovers.length > 0 ? (
                fastMovers.slice(0, 5).map((product) => (
                  <Box key={product.id} bg="green.50" p={3} rounded="md" border="1px" borderColor="green.200">
                    <HStack justify="space-between" mb={1}>
                      <VStack align="start" spacing={0}>
                        <Text fontWeight="bold" fontSize="sm">
                          {product.name}
                        </Text>
                        <Text fontSize="xs" color="gray.600">
                          SKU: {product.sku}
                        </Text>
                      </VStack>
                      <Badge colorScheme="green">{product.total_outbound} unit</Badge>
                    </HStack>
                    <HStack justify="space-between" fontSize="xs" color="gray.600">
                      <Text>{product.transaction_count} transaksi</Text>
                      <Text>Stok: {product.current_stock}</Text>
                    </HStack>
                  </Box>
                ))
              ) : (
                <Text color="gray.500" fontSize="sm">
                  Tidak ada data
                </Text>
              )}
            </VStack>
          </Box>

          {/* Slow Movers */}
          <Box bg={cardBg} shadow="md" rounded="lg" p={6} border="1px" borderColor={borderColor}>
            <Heading size="lg" mb={4} display="flex" alignItems="center" gap={2}>
              <Icon as={FiTrendingDown} color="orange.500" /> Top 10 Slow/Dead Stock
            </Heading>
            <VStack gap={3} align="stretch">
              {slowMovers && slowMovers.length > 0 ? (
                slowMovers.slice(0, 5).map((product) => (
                  <Box key={product.id} bg="orange.50" p={3} rounded="md" border="1px" borderColor="orange.200">
                    <HStack justify="space-between" mb={1}>
                      <VStack align="start" spacing={0}>
                        <Text fontWeight="bold" fontSize="sm">
                          {product.name}
                        </Text>
                        <Text fontSize="xs" color="gray.600">
                          SKU: {product.sku}
                        </Text>
                      </VStack>
                      <Badge colorScheme="orange">{product.days_no_movement} hari</Badge>
                    </HStack>
                    <HStack justify="space-between" fontSize="xs" color="gray.600">
                      <Text>Stok: {product.current_stock}</Text>
                      <Text>{formatCurrency(product.stock_value)}</Text>
                    </HStack>
                  </Box>
                ))
              ) : (
                <Text color="gray.500" fontSize="sm">
                  Tidak ada data
                </Text>
              )}
            </VStack>
          </Box>
        </SimpleGrid>

        {/* ============ SECTION 4: CATEGORY PERFORMANCE ============ */}
        <Box bg={cardBg} shadow="md" rounded="lg" p={6} border="1px" borderColor={borderColor}>
          <Heading size="lg" mb={4} display="flex" alignItems="center" gap={2}>
            <Icon as={FiPieChart} /> Category Performance (30 hari)
          </Heading>
          {categoryPerformance && categoryPerformance.length > 0 ? (
            <Box overflowX="auto">
              <Box as="div" borderWidth="1px" borderColor={borderColor} rounded="md" overflow="hidden">
                {/* Header */}
                <Box
                  display="grid"
                  gridTemplateColumns="2fr 1fr 1fr 1fr 1fr 1fr"
                  bg="gray.100"
                  borderBottom="1px"
                  borderColor={borderColor}
                  fontWeight="bold"
                  fontSize="sm"
                >
                  <Box p={3}>Kategori</Box>
                  <Box p={3} textAlign="right">Produk</Box>
                  <Box p={3} textAlign="right">Nilai Stok</Box>
                  <Box p={3} textAlign="right">Inbound</Box>
                  <Box p={3} textAlign="right">Outbound</Box>
                  <Box p={3} textAlign="right">Rendah</Box>
                </Box>
                {/* Body */}
                {categoryPerformance.map((cat) => (
                  <Box
                    key={cat.category_id}
                    display="grid"
                    gridTemplateColumns="2fr 1fr 1fr 1fr 1fr 1fr"
                    borderBottom="1px"
                    borderColor={borderColor}
                    fontSize="sm"
                  >
                    <Box p={3} fontWeight="medium">{cat.category_name}</Box>
                    <Box p={3} textAlign="right">{cat.total_products}</Box>
                    <Box p={3} textAlign="right">{formatCurrency(cat.total_value)}</Box>
                    <Box p={3} textAlign="right">
                      <Badge colorScheme="green">{cat.inbound_30days}</Badge>
                    </Box>
                    <Box p={3} textAlign="right">
                      <Badge colorScheme="red">{cat.outbound_30days}</Badge>
                    </Box>
                    <Box p={3} textAlign="right">
                      {cat.low_stock_count > 0 ? (
                        <Badge colorScheme="orange">{cat.low_stock_count}</Badge>
                      ) : (
                        '‚Äî'
                      )}
                    </Box>
                  </Box>
                ))}
              </Box>
            </Box>
          ) : (
            <Text color="gray.500">Tidak ada data</Text>
          )}
        </Box>

        {/* ============ SECTION 5: OPERATIONAL STATISTICS ============ */}
        <SimpleGrid columns={{ base: 1, lg: 2 }} gap={6}>
              <Td isNumeric>
                {cat.low_stock_count > 0 ? (
                  <Badge colorScheme="orange">{cat.low_stock_count}</Badge>
                ) : (
                  '‚Äî'
                )}
              </Td>
            </Box>
              </Box>
                )}
              </Box>
            </Box>
          ) : (
            <Text color="gray.500">Tidak ada data</Text>
          )}
        </Box>

        {/* ============ SECTION 5: OPERATIONAL STATISTICS ============ */}
        <SimpleGrid columns={{ base: 1, lg: 2 }} gap={6}>
          {/* Operational Stats */}
          <Box bg={cardBg} shadow="md" rounded="lg" p={6} border="1px" borderColor={borderColor}>
            <Heading size="lg" mb={4} display="flex" alignItems="center" gap={2}>
              <Icon as={FiBarChart2} /> Operational Stats (30 hari)
            </Heading>
            <VStack gap={4} align="stretch">
              <Box>
                <HStack justify="space-between" mb={1}>
                  <Text fontSize="sm" fontWeight="medium">Total Transaksi</Text>
                  <Text fontSize="lg" fontWeight="bold">
                    {operationalStats?.total_transactions_30days || 0}
                  </Text>
                </HStack>
                <HStack fontSize="xs" color="gray.600" gap={4}>
                  <HStack gap={1}>
                    <Icon as={FiArrowUp} color="green.500" boxSize={4} />
                    <Text>Masuk: {operationalStats?.inbound_transactions_30days}</Text>
                  </HStack>
                  <HStack gap={1}>
                    <Icon as={FiArrowDown} color="red.500" boxSize={4} />
                    <Text>Keluar: {operationalStats?.outbound_transactions_30days}</Text>
                  </HStack>
                </HStack>
              </Box>
              <Box borderTop="1px" borderColor={borderColor} pt={4}>
                <Text fontSize="sm" fontWeight="medium" mb={2}>
                  Rata-rata per Hari
                </Text>
                <Text fontSize="2xl" fontWeight="bold" color="blue.600">
                  {operationalStats?.avg_transactions_per_day.toFixed(1)} transaksi
                </Text>
              </Box>
            </VStack>
          </Box>

          {/* Top Operators */}
          <Box bg={cardBg} shadow="md" rounded="lg" p={6} border="1px" borderColor={borderColor}>
            <Heading size="lg" mb={4} display="flex" alignItems="center" gap={2}>
              <Icon as={FiUsers} /> Top Operators (30 hari)
            </Heading>
            <VStack gap={3} align="stretch">
              {operationalStats &&
              operationalStats.top_operators &&
              operationalStats.top_operators.length > 0 ? (
                operationalStats.top_operators.map((op, idx) => (
                  <Box key={op.user_id} bg="blue.50" p={3} rounded="md" border="1px" borderColor="blue.200">
                    <HStack justify="space-between">
                      <HStack gap={2}>
                        <Text fontSize="lg" fontWeight="bold" color="blue.600" minW={6}>
                          #{idx + 1}
                        </Text>
                        <VStack align="start" spacing={0}>
                          <Text fontWeight="medium" fontSize="sm">
                            {op.operator_name}
                          </Text>
                        </VStack>
                      </HStack>
                      <Badge colorScheme="blue">{op.transaction_count} transaksi</Badge>
                    </HStack>
                  </Box>
                ))
              ) : (
                <Text color="gray.500" fontSize="sm">
                  Tidak ada data
                </Text>
              )}
            </VStack>
          </Box>
        </SimpleGrid>

        {/* ============ SECTION 6: STOCK STATUS SUMMARY ============ */}
        <SimpleGrid columns={{ base: 1, md: 3 }} gap={4}>
          <Box bg="teal.500" color="white" shadow="md" rounded="lg" p={6}>
            <Stack gap={2}>
              <Text fontSize="sm" display="flex" alignItems="center" gap={2}>
                <Icon as={FiPackage} /> Total Produk
              </Text>
              <Text fontSize="3xl" fontWeight="bold">
                {products.length}
              </Text>
            </Stack>
          </Box>

          <Box bg="orange.500" color="white" shadow="md" rounded="lg" p={6}>
            <Stack gap={2}>
              <Text fontSize="sm" display="flex" alignItems="center" gap={2}>
                <Icon as={FiAlertTriangle} /> Stok Rendah
              </Text>
              <Text fontSize="3xl" fontWeight="bold">
                {lowStockProducts}
              </Text>
            </Stack>
          </Box>

          <Box bg="green.500" color="white" shadow="md" rounded="lg" p={6}>
            <Stack gap={2}>
              <Text fontSize="sm" display="flex" alignItems="center" gap={2}>
                <Icon as={FiTrendingUp} /> Status
              </Text>
              <Text fontSize="3xl" fontWeight="bold">
                {lowStockProducts === 0 ? '‚úì Aman' : '‚ö† Alert'}
              </Text>
            </Stack>
          </Box>
        </SimpleGrid>

        {/* ============ SYSTEM INFO ============ */}
        <Box bg="blue.50" border="1px" borderColor="blue.200" p={4} rounded="md">
          <Text fontWeight="bold" color="blue.700" mb={2}>
            ‚ÑπÔ∏è Informasi Sistem
          </Text>
          <Text fontSize="sm" color="blue.700" mb={2}>
            Dashboard ini menampilkan analytics real-time berdasarkan data transaksi dan snapshot stok. Semua data
            diperbarui setiap kali Anda membuka halaman ini.
          </Text>
          <Box as="ul" mt={2} pl={6} fontSize="sm" color="blue.700" spacing={1}>
            <li>üìä Financial metrics didasarkan pada stok & harga saat ini + 30 hari terakhir</li>
            <li>üöÄ Fast movers = produk dengan outbound terbanyak (top 10)</li>
            <li>üêå Slow movers = produk tanpa outbound selama 30+ hari</li>
            <li>üö® Critical alerts = stok kritis, overstock, zero movement, & negative margin</li>
            <li>üìà Category performance = ringkasan per kategori (stok, value, transaksi 30 hari)</li>
            <li>‚ö° Operational stats = total transaksi, top operators, & turnover rate 30 hari</li>
          </Box>
        </Box>
      </Stack>
    </WarehouseLayout>
  );
}
